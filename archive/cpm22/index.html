<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>CP/M 2.2 Emulator</title>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/xterm@5.3.0/css/xterm.css">
  <style>
    body {
      background: #1a1a2e;
      color: #eee;
      font-family: 'Segoe UI', Arial, sans-serif;
      margin: 0;
      padding: 20px;
    }
    h1 {
      color: #00ff88;
      margin-bottom: 10px;
    }
    #status {
      color: #888;
      margin-bottom: 10px;
      font-size: 14px;
    }
    #terminal-container {
      border: 2px solid #333;
      border-radius: 8px;
      overflow: hidden;
      display: inline-block;
    }
    .controls {
      margin: 15px 0;
    }
    button {
      background: #00aa66;
      color: white;
      border: none;
      padding: 4px 12px;
      margin-right: 8px;
      border-radius: 4px;
      cursor: pointer;
      font-size: 13px;
    }
    button:hover {
      background: #00cc77;
    }
    button:disabled {
      background: #555;
      cursor: not-allowed;
    }
    .file-input {
      margin: 4px 0;
    }
    label {
      display: inline-block;
      margin-right: 8px;
      font-size: 13px;
    }
    .header-row {
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    .disk-format {
      font-size: 12px;
      color: #666;
    }
  </style>
</head>
<body>
  <div class="header-row">
    <h1>CP/M 2.2 Emulator <a href="https://github.com/avwohl/cpmemu" style="font-size:12px;color:#888;margin-left:10px;">[sources]</a> <span style="font-size:11px;color:#555;">v1.9</span></h1>
    <span class="disk-format">A:/B: IBM 8" SSSD (250KB) | C: 8MB HD</span>
  </div>
  <div id="status">Loading...</div>

  <div class="controls">
    <div class="file-input">
      <label>System:</label><input type="file" id="sysFile" accept=".sys,.bin">
      <label style="margin-left:12px;">A:</label><input type="file" id="diskFile" accept=".img,.dsk"><button id="downloadBtn" disabled>↓A:</button>
      <label style="margin-left:12px;">B:</label><input type="file" id="diskBFile" accept=".img,.dsk"><button id="downloadBBtn" disabled>↓B:</button>
    </div>
    <div class="file-input">
      <label>C:</label><input type="file" id="diskCFile" accept=".img,.dsk"><button id="createCBtn">Create C:</button><button id="downloadCBtn" disabled>↓C:</button>
      <button id="startBtn" disabled style="margin-left:20px;">Start CP/M</button>
      <button id="stopBtn" disabled>Stop</button>
    </div>
  </div>

  <div id="terminal-container">
    <div id="terminal"></div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/xterm@5.3.0/lib/xterm.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/xterm-addon-fit@0.8.0/lib/xterm-addon-fit.min.js"></script>
  <script src="cpm.js"></script>
  <script>
    // Terminal setup
    const term = new Terminal({
      cols: 80,
      rows: 24,
      cursorBlink: true,
      fontSize: 16,
      fontFamily: 'Consolas, Monaco, monospace',
      theme: {
        background: '#0a0a1a',
        foreground: '#00ff88',
        cursor: '#00ff88'
      }
    });
    const fitAddon = new FitAddon.FitAddon();
    term.loadAddon(fitAddon);
    term.open(document.getElementById('terminal'));
    fitAddon.fit();

    const statusDiv = document.getElementById('status');
    const startBtn = document.getElementById('startBtn');
    const stopBtn = document.getElementById('stopBtn');
    const downloadBtn = document.getElementById('downloadBtn');
    const downloadBBtn = document.getElementById('downloadBBtn');
    const downloadCBtn = document.getElementById('downloadCBtn');
    const createCBtn = document.getElementById('createCBtn');
    const sysFile = document.getElementById('sysFile');
    const diskFile = document.getElementById('diskFile');
    const diskBFile = document.getElementById('diskBFile');
    const diskCFile = document.getElementById('diskCFile');

    let systemLoaded = false;
    let diskLoaded = false;

    // Console output from emulator
    Module.onConsoleOutput = function(ch) {
      if (ch === 13) {  // CR
        term.write('\r\n');
      } else if (ch === 8) {  // Backspace
        term.write('\b \b');
      } else if (ch >= 32 && ch < 127) {
        term.write(String.fromCharCode(ch));
      }
    };

    // Status messages from emulator
    Module.onStatus = function(msg) {
      statusDiv.textContent = msg;
    };

    // Keyboard input to emulator
    term.onKey(function(e) {
      if (Module._cpm_key_input) {
        let ch = e.key.charCodeAt(0);
        if (e.key === 'Enter') ch = 13;
        else if (e.key === 'Backspace') ch = 8;
        else if (e.key === 'Delete') ch = 127;
        Module._cpm_key_input(ch);
      }
    });

    // Load system file
    sysFile.addEventListener('change', function(e) {
      const file = e.target.files[0];
      if (!file) return;
      const reader = new FileReader();
      reader.onload = function(e) {
        const data = new Uint8Array(e.target.result);
        const ptr = Module._malloc(data.length);
        Module.HEAPU8.set(data, ptr);
        Module._cpm_load_system(ptr, data.length);
        Module._free(ptr);
        systemLoaded = true;
        updateButtons();
        statusDiv.textContent = 'System loaded: ' + file.name;
      };
      reader.readAsArrayBuffer(file);
    });

    // Load disk A file
    diskFile.addEventListener('change', function(e) {
      const file = e.target.files[0];
      if (!file) return;
      const reader = new FileReader();
      reader.onload = function(e) {
        const data = new Uint8Array(e.target.result);
        const ptr = Module._malloc(data.length);
        Module.HEAPU8.set(data, ptr);
        Module._cpm_load_disk(ptr, data.length);
        Module._free(ptr);
        diskLoaded = true;
        updateButtons();
        statusDiv.textContent = 'Disk A loaded: ' + file.name;
      };
      reader.readAsArrayBuffer(file);
    });

    // Load disk B file
    diskBFile.addEventListener('change', function(e) {
      const file = e.target.files[0];
      if (!file) return;
      const reader = new FileReader();
      reader.onload = function(e) {
        const data = new Uint8Array(e.target.result);
        const ptr = Module._malloc(data.length);
        Module.HEAPU8.set(data, ptr);
        Module._cpm_load_disk_b(ptr, data.length);
        Module._free(ptr);
        downloadBBtn.disabled = false;
        statusDiv.textContent = 'Disk B loaded: ' + file.name;
      };
      reader.readAsArrayBuffer(file);
    });

    // Load disk C file (8MB hard disk)
    diskCFile.addEventListener('change', function(e) {
      const file = e.target.files[0];
      if (!file) return;
      const reader = new FileReader();
      reader.onload = function(e) {
        const data = new Uint8Array(e.target.result);
        const ptr = Module._malloc(data.length);
        Module.HEAPU8.set(data, ptr);
        Module._cpm_load_disk_c(ptr, data.length);
        Module._free(ptr);
        downloadCBtn.disabled = false;
        statusDiv.textContent = 'Disk C loaded: ' + file.name + ' (8MB HD)';
      };
      reader.readAsArrayBuffer(file);
    });

    // Create empty disk C
    createCBtn.addEventListener('click', function() {
      if (Module._cpm_create_disk_c) {
        Module._cpm_create_disk_c();
        downloadCBtn.disabled = false;
      }
    });

    // Start button
    startBtn.addEventListener('click', function() {
      term.clear();
      Module._cpm_start();
      startBtn.disabled = true;
      stopBtn.disabled = false;
      downloadBtn.disabled = false;
    });

    // Stop button
    stopBtn.addEventListener('click', function() {
      Module._cpm_stop();
      startBtn.disabled = false;
      stopBtn.disabled = true;
      statusDiv.textContent = 'Stopped';
    });

    // Download disk A
    downloadBtn.addEventListener('click', function() {
      const size = Module._cpm_get_disk_size();
      const ptr = Module._cpm_get_disk_data();
      const data = new Uint8Array(Module.HEAPU8.buffer, ptr, size);
      const blob = new Blob([data], {type: 'application/octet-stream'});
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = 'cpm_disk_a.img';
      a.click();
      URL.revokeObjectURL(url);
    });

    // Download disk B
    downloadBBtn.addEventListener('click', function() {
      const size = Module._cpm_get_disk_b_size();
      const ptr = Module._cpm_get_disk_b_data();
      const data = new Uint8Array(Module.HEAPU8.buffer, ptr, size);
      const blob = new Blob([data], {type: 'application/octet-stream'});
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = 'cpm_disk_b.img';
      a.click();
      URL.revokeObjectURL(url);
    });

    // Download disk C (8MB)
    downloadCBtn.addEventListener('click', function() {
      const size = Module._cpm_get_disk_c_size();
      const ptr = Module._cpm_get_disk_c_data();
      const data = new Uint8Array(Module.HEAPU8.buffer, ptr, size);
      const blob = new Blob([data], {type: 'application/octet-stream'});
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = 'cpm_disk_c_8mb.img';
      a.click();
      URL.revokeObjectURL(url);
    });

    function updateButtons() {
      startBtn.disabled = !(systemLoaded && diskLoaded);
    }

    // Click on terminal to focus it
    document.getElementById('terminal-container').addEventListener('click', function() {
      term.focus();
    });

    // Wait for WASM to load, then auto-start
    Module.onRuntimeInitialized = function() {
      statusDiv.textContent = 'Starting CP/M...';
      term.writeln('CP/M 2.2 Emulator - WebAssembly Edition');
      term.writeln('');

      // Auto-start with bundled files
      setTimeout(function() {
        if (Module._cpm_autostart) {
          Module._cpm_autostart();
          startBtn.disabled = true;
          stopBtn.disabled = false;
          downloadBtn.disabled = false;
          downloadCBtn.disabled = false;  // C: is bundled
          // Auto-focus the terminal so typing works immediately
          term.focus();
        }
      }, 100);
    };
  </script>
</body>
</html>
